#!/bin/bash

# TODO
    # contain alpha-numeric characters plus '.', '-' and '_' characters.

if [ $# -eq 0 ]; then
    echo "usage: legit-add <filenames>";
    exit 1;
fi

if ! [ -d ".legit" ]; then
    echo "legit-add: error: no .legit directory containing legit repository exists";    # not $0
    exit 1;
fi

index='.legit/index';
for i in $@
do
    if [ ! -f "$i" ] && [ "`grep -o "^$i\$" "$index/.status"`" ]; then
        # file has been rmed so take out of .status and index
        if [ -f "$index/.status" ]; then
            sed -i "/\/$i$/d" "$index/.status"; # delete from status
        fi
        if [ -f "$index/.index" ]; then
            sed -i "/\/$i$/d" "$index/.index"; # delete from index
        fi

        if [ -f "$index/$i" ]; then
            rm "$index/$i";
        fi
        continue;
    fi

    if echo "$i" | egrep -qv "^[a-zA-Z0-9.-_]"; then
        continue;
    fi

    if [ -f "$i" ]; then
        # cat "$index/.index";

        # MIGHT WANT TO CHANGE GREP: [IT WORKS BUT NOT THE BEST]
        if [ "`grep "\/*$i\$" "$index/.index"`" ]; then
            # replace="`grep -o "\/*$i\$" "$index/.index"`";
            # echo $replace;
            # echo "HERE";
            # update hashes in .index
            index_sha="`grep "$i$" "$index/.index" | cut -d' ' -f1`";
            main_sha="`shasum "$i" | cut -d' ' -f1`";       # update hashes
            # echo $index_sha; echo $main_sha;
            # [ "$main_sha" != "$index_sha" ] && echo "`shasum $i`" >> "$index/.index";       # update hashes
            # [ "$main_sha" != "$index_sha" ] && sed -i s/"$replace"/"`shasum "$i"`"/ "$index/.index";
            if [ "$main_sha" != "$index_sha" ]; then
                # sed -i -e "s/"$replace"/"`shasum "$i"`"/" "$index/.index";
                sed -i -e "/$index_sha/d" "$index/.index";
                echo "`shasum $i`" >> "$index/.index";
                rm "$index/.index-e";
            fi
        fi

        # move to index
        cp "$i" "$index/$i"
    else
        echo "legit-add: error: can not open '$i'";
        exit 1;     # TODO: delete if fail autotest
    fi
done
